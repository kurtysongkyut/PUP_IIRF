<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUP_IIRF Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
      .admin-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1.5em;
      }
      .admin-table th, .admin-table td {
        border: 1px solid #ccc;
        padding: 6px 10px;
        font-size: 0.95em;
      }
      .admin-table th {
        background: #f5f5f5;
      }
      .admin-actions button {
        margin-right: 5px;
        padding: 2px 8px;
        font-size: 0.95em;
      }
      .admin-header {
        display: flex;
        align-items: center;
        gap: 1em;
      }
      .admin-header img {
        height: 48px;
      }
      .admin-search {
        margin: 1em 0;
      }
      .admin-search input {
        padding: 4px 8px;
        font-size: 1em;
      }
      .action-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border: none;
        border-radius: 4px;
        padding: 6px 14px;
        margin-right: 6px;
        font-size: 1em;
        font-weight: 500;
        background: #f3f4f6;
        color: #374151;
        cursor: pointer;
        transition: background 0.2s, box-shadow 0.2s;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      }
      .action-btn svg {
        vertical-align: middle;
      }
      .action-btn:hover {
        background: #e0e7ef;
      }
      .view-btn { color: #2563eb; }
      .edit-btn { color: #059669; }
      .delete-btn { color: #dc2626; }
      .delete-btn:hover { background: #fee2e2; }
      .edit-btn:hover { background: #d1fae5; }
      .view-btn:hover { background: #dbeafe; }
      .download-btn { color: #7c3aed; }
      .download-btn:hover { background: #ede9fe; }
    </style>
</head>
<body>
    <header class="main-header">
      <div class="logo-circle">
        <img src="PUP.png" alt="PUP Logo" class="logo left-logo">
      </div>
      <div class="header-content">
        <h1>ADMIN DASHBOARD</h1>
        <div class="gold-line"></div>
      </div>
    </header>
    <nav class="main-menu">
      <ul>
        <li><a href="admin.html" class="active">ADMIN</a></li>
        <li><a href="update.html">UPDATE</a></li>
        <li><a href="#">HELP</a></li>
      </ul>
    </nav>
    <main>
        <section class="main-card">
            <div class="admin-header">
              <h2>Manage IIRF Submissions</h2>
              <button onclick="fetchIIRF()">Refresh</button>
            </div>
            <div class="admin-search">
              <input type="text" id="searchInput" placeholder="Search by name or email..." oninput="filterTable()">
            </div>
            <div id="adminTableContainer">
              <p>Loading data...</p>
            </div>
        </section>
    </main>
    <button onclick="logout()" style="float:right;">Logout</button>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // Initialize Supabase
      const supabase = window.supabase.createClient('https://npyyaoddrquxwvkliupl.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5weXlhb2RkcnF1eHd2a2xpdXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2OTQyOTYsImV4cCI6MjA2NTI3MDI5Nn0.aBXknpBk6wq0YgFjVYfSZm2GqUacieZNq8-rny__Et0');
      supabase.auth.getSession().then(({ data: { session } }) => {
        if (!session) window.location.href = 'login.html';
      });

      let iirfData = [];

      // Check admin login status
      if (sessionStorage.getItem('iirf_admin_logged_in') !== 'yes') {
        window.location.href = 'login.html';
      }

      // Fetch all IIRF form submissions
      async function fetchIIRF() {
        document.getElementById('adminTableContainer').innerHTML = '<p>Loading data...</p>';
        const { data, error } = await supabase.from('iirf_forms').select('*').order('id', { ascending: false });
        if (error) {
          document.getElementById('adminTableContainer').innerHTML = '<p style="color:red;">Error loading data: ' + error.message + '</p>';
          return;
        }
        iirfData = data;
        renderTable(data);
      }

      // Render the table of submissions
      function renderTable(data) {
        if (!data.length) {
          document.getElementById('adminTableContainer').innerHTML = '<p>No submissions found.</p>';
          return;
        }
        let html = `<table class="admin-table" id="adminTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Course/Section</th>
              <th>Age</th>
              <th>Father Name</th>
              <th>Date Submitted</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>`;
        for (const row of data) {
          html += `<tr data-id="${row.id}">
            <td>${row.id || ''}</td>
            <td>${row.surname || ''}, ${row.first_name || ''} ${row.middle_name || ''}</td>
            <td>${row['Email Address'] || row.email || ''}</td>
            <td>${row['Course, Year and Section'] || row.course_year_section || ''}</td>
            <td>${row.age || ''}</td>
            <td>${row.father_name || ''}</td>
            <td>${row.created_at ? new Date(row.created_at).toLocaleString() : ''}</td>
            <td class="admin-actions">
              <button class="action-btn view-btn" onclick="viewDetails('${row.id}')">View</button>
              <button class="action-btn edit-btn" onclick="editRow('${row.id}')">Edit</button>
              <button class="action-btn delete-btn" onclick="deleteRow('${row.id}')">Delete</button>
              <button class="action-btn download-btn" onclick="downloadRow('${row.id}')">Download</button>
            </td>
          </tr>`;
        }
        html += `</tbody></table>
        <div id="detailsModal" style="display:none; position:fixed; top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1000;">
          <div style="background:#fff;max-width:700px;width:90vw;max-height:90vh;overflow:auto;padding:2em;position:relative;">
            <button onclick="closeModal()" style="position:absolute;top:8px;right:12px;font-size:1.2em;">&times;</button>
            <div id="modalContent"></div>
          </div>
        </div>`;
        document.getElementById('adminTableContainer').innerHTML = html;
      }

      // View details modal
      function viewDetails(id) {
        const row = iirfData.find(r => r.id === id);
        if (!row) return;
        let html = '<h3>Submission Details</h3><table style="width:100%">';
        for (const key in row) {
          if (key === 'id' || key === 'created_at') continue;
          html += `<tr><td style="font-weight:bold;">${key}</td><td>${row[key]}</td></tr>`;
        }
        html += `<tr><td style="font-weight:bold;">Submitted At</td><td>${row.created_at ? new Date(row.created_at).toLocaleString() : ''}</td></tr>`;
        html += '</table>';
        document.getElementById('modalContent').innerHTML = html;
        document.getElementById('detailsModal').style.display = 'flex';
      }
      function closeModal() {
        document.getElementById('detailsModal').style.display = 'none';
      }

      // Delete a row
      async function deleteRow(id) {
        if (!confirm('Are you sure you want to delete this submission?')) return;
        const { error } = await supabase.from('iirf_forms').delete().eq('id', id);
        if (error) {
          alert('Error deleting: ' + error.message);
        } else {
          iirfData = iirfData.filter(r => r.id !== id);
          renderTable(iirfData);
        }
      }

      // Download a row as CSV
      window.downloadRow = function(id) {
        const row = iirfData.find(r => r.id === id);
        if (!row) return alert('Record not found!');
        // Prepare CSV content for this row
        const keys = Object.keys(row);
        const csv = keys.join(',') + '\n' + keys.map(k => `"${(row[k] ?? '').toString().replace(/"/g, '""')}"`).join(',');
        // Create a blob and trigger download
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `iirf_${row.id}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // Filter table by search
      function filterTable() {
        const val = document.getElementById('searchInput').value.trim().toLowerCase();
        if (!val) {
          renderTable(iirfData);
          return;
        }
        const filtered = iirfData.filter(row =>
          ((row.surname || '') + ' ' + (row.first_name || '') + ' ' + (row.middle_name || '')).toLowerCase().includes(val) ||
          ((row['Email Address'] || row.email || '')).toLowerCase().includes(val)
        );
        renderTable(filtered);
      }

      // Initial fetch
      fetchIIRF();
      // Expose for inline onclick
      window.viewDetails = viewDetails;
      window.closeModal = closeModal;
      window.deleteRow = deleteRow;
      window.fetchIIRF = fetchIIRF;
      window.filterTable = filterTable;
      window.editRow = function(id) {
        window.location.href = `update.html?id=${id}`;
      };
      async function logout() {
        await supabase.auth.signOut();
        sessionStorage.removeItem('iirf_admin_logged_in');
        window.location.href = 'login.html';
      }
      window.logout = logout;
    </script>
    <svg style="display:none;">
      <symbol id="icon-view" viewBox="0 0 16 16">
        <path d="M8 3C3.5 3 1 8 1 8s2.5 5 7 5 7-5 7-5-2.5-5-7-5zm0 8a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
        <circle cx="8" cy="8" r="1.5"/>
      </symbol>
      <symbol id="icon-edit" viewBox="0 0 16 16">
        <path d="M12.146 3.146a.5.5 0 0 1 .708 0l.707.707a.5.5 0 0 1 0 .708l-8.5 8.5a.5.5 0 0 1-.168.11l-3 1a.5.5 0 0 1-.65-.65l1-3a.5.5 0 0 1 .11-.168l8.5-8.5z"/>
      </symbol>
      <symbol id="icon-delete" viewBox="0 0 16 16">
        <path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5z"/>
        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2h3.5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1H14.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118z"/>
      </symbol>
    </svg>
</body>
</html>